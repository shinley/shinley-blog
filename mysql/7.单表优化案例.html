<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>7.单表优化案例 | 陈新磊的读书笔记</title>
    <meta name="description" content="Just playing around">
    
    
    <link rel="preload" href="/assets/css/styles.f518d815.css" as="style"><link rel="preload" href="/assets/js/app.f518d815.js" as="script"><link rel="preload" href="/assets/js/27.6d00f7aa.js" as="script"><link rel="prefetch" href="/assets/js/16.a05f5c53.js"><link rel="prefetch" href="/assets/css/1.styles.5a8ea794.css"><link rel="prefetch" href="/assets/js/1.5a8ea794.js"><link rel="prefetch" href="/assets/css/2.styles.cf289c67.css"><link rel="prefetch" href="/assets/js/2.cf289c67.js"><link rel="prefetch" href="/assets/js/3.ebd152b3.js"><link rel="prefetch" href="/assets/js/4.17531713.js"><link rel="prefetch" href="/assets/js/5.af9e6587.js"><link rel="prefetch" href="/assets/js/6.fc925cca.js"><link rel="prefetch" href="/assets/js/7.603902a0.js"><link rel="prefetch" href="/assets/js/8.d2d6cb3f.js"><link rel="prefetch" href="/assets/js/9.1b044dfa.js"><link rel="prefetch" href="/assets/js/10.931c5de7.js"><link rel="prefetch" href="/assets/js/11.c02b6a22.js"><link rel="prefetch" href="/assets/js/12.905af051.js"><link rel="prefetch" href="/assets/js/13.43b353fc.js"><link rel="prefetch" href="/assets/js/14.6b313113.js"><link rel="prefetch" href="/assets/js/15.f92f208f.js"><link rel="prefetch" href="/assets/js/17.f7e63732.js"><link rel="prefetch" href="/assets/js/18.cfdb5582.js"><link rel="prefetch" href="/assets/js/19.f9c23d6f.js"><link rel="prefetch" href="/assets/js/20.ca5cacc5.js"><link rel="prefetch" href="/assets/js/21.b9a3f6bf.js"><link rel="prefetch" href="/assets/js/22.ad52503d.js"><link rel="prefetch" href="/assets/js/23.b50655b8.js"><link rel="prefetch" href="/assets/js/24.ae33eca4.js"><link rel="prefetch" href="/assets/js/25.35319afc.js"><link rel="prefetch" href="/assets/js/26.14cfb51c.js"><link rel="prefetch" href="/assets/js/28.9adb62e6.js"><link rel="prefetch" href="/assets/js/29.96b612e5.js"><link rel="prefetch" href="/assets/js/30.d16089d8.js"><link rel="prefetch" href="/assets/js/31.833984b0.js"><link rel="prefetch" href="/assets/js/32.0f873b57.js"><link rel="prefetch" href="/assets/js/33.e1a966ad.js"><link rel="prefetch" href="/assets/js/34.1e435d13.js"><link rel="prefetch" href="/assets/js/35.400e2100.js">
    <link rel="stylesheet" href="/assets/css/1.styles.5a8ea794.css"><link rel="stylesheet" href="/assets/css/2.styles.cf289c67.css"><link rel="stylesheet" href="/assets/css/styles.f518d815.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">陈新磊的读书笔记</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/python/fabric.html" class="nav-link">主页</a></div><div class="nav-item"><a href="/mongodb/" class="nav-link">MongoDB</a></div><div class="nav-item"><a href="/redis/" class="nav-link">Redis</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/python/fabric.html" class="nav-link">主页</a></div><div class="nav-item"><a href="/mongodb/" class="nav-link">MongoDB</a></div><div class="nav-item"><a href="/redis/" class="nav-link">Redis</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>Python</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/python/fabric.html" class="sidebar-link">自动化部署工具Fabric</a></li><li><a href="/python/subprocess.html" class="sidebar-link">Subprocess调用shell命令</a></li><li><a href="/python/pexpect.html" class="sidebar-link">自动化交互式的命令行pexpect</a></li><li><a href="/python/crashzip.html" class="sidebar-link">暴力破解zip压缩包的密码</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>JAVA</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/java/jvm.html" class="sidebar-link">JVM性能调优</a></li><li><a href="/java/thread.html" class="sidebar-link">多线程</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>MySQL</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/mysql/1.Install-MySQL5.7.22.html" class="sidebar-link">1. MySQL 5.7.22安装</a></li><li><a href="/mysql/2.MySQL-User-Manager.html" class="sidebar-link">2. MySQL 用户管理</a></li><li><a href="/mysql/3.MySQL备份与还原.html" class="sidebar-link">3.MySql备份与还原</a></li><li><a href="/mysql/4.七种连接方式.html" class="sidebar-link">4.七种连接方式</a></li><li><a href="/mysql/5.MySQL索引01.html" class="sidebar-link">5.MySQL索引（一）</a></li><li><a href="/mysql/6.MySQL索引02.html" class="sidebar-link">6.MySQL索引(二)</a></li><li><a href="/mysql/7.单表优化案例.html" class="active sidebar-link">7.单表优化案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mysql/7.单表优化案例.html#数据准备" class="sidebar-link">数据准备</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mysql/7.单表优化案例.html#需求" class="sidebar-link">需求</a></li><li class="sidebar-sub-header"><a href="/mysql/7.单表优化案例.html#分析" class="sidebar-link">分析</a></li></ul></li><li class="sidebar-sub-header"><a href="/mysql/7.单表优化案例.html#开始优化" class="sidebar-link">开始优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mysql/7.单表优化案例.html#再次分析" class="sidebar-link">再次分析</a></li></ul></li><li class="sidebar-sub-header"><a href="/mysql/7.单表优化案例.html#结论" class="sidebar-link">结论</a></li></ul></li><li><a href="/mysql/8.两表和三表优化案例.html" class="sidebar-link">8. 两表和三表优化案例</a></li><li><a href="/mysql/9.索引优化01.html" class="sidebar-link">9.索引优化(一)</a></li><li><a href="/mysql/10.索引优化02.html" class="sidebar-link">10.索引优化(二)</a></li><li><a href="/mysql/11.索引优化03.html" class="sidebar-link">11. 索引优化(三)</a></li><li><a href="/mysql/12.索引优化04.html" class="sidebar-link">12. 索引优化(四)</a></li><li><a href="/mysql/13.索引优化05.html" class="sidebar-link">13.索引优化(五)</a></li><li><a href="/mysql/14.索引优化06.html" class="sidebar-link">14. 索引优化(六)</a></li><li><a href="/mysql/15.索引优化07.html" class="sidebar-link">15.索引优化(七)</a></li><li><a href="/mysql/16.索引优化08.html" class="sidebar-link">16.索引优化(八)</a></li><li><a href="/mysql/17.索引面试题.html" class="sidebar-link">17.索引面试题</a></li><li><a href="/mysql/18.小表驱动大表.html" class="sidebar-link">18.小表驱动大表</a></li><li><a href="/mysql/19.order by关键字优化.html" class="sidebar-link">19.order by关键字优化</a></li><li><a href="/mysql/20.慢查询日志分析.html" class="sidebar-link">20.慢查询日志分析</a></li><li><a href="/mysql/21.批量数据脚本.html" class="sidebar-link">21.批量数据脚本</a></li><li><a href="/mysql/22.Show Profile.html" class="sidebar-link">22.Show Profile</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="_7-单表优化案例"><a href="#_7-单表优化案例" aria-hidden="true" class="header-anchor">#</a> 7.单表优化案例</h1> <h2 id="数据准备"><a href="#数据准备" aria-hidden="true" class="header-anchor">#</a> 数据准备</h2> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>article<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>author_id<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>     <span class="token comment">-- 作者id</span>
  <span class="token punctuation">`</span>category_id<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>   <span class="token comment">-- 分类id</span>
  <span class="token punctuation">`</span>views<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>         <span class="token comment">-- 被查看的次数</span>
  <span class="token punctuation">`</span>comments<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>      <span class="token comment">-- 评论备注</span>
  <span class="token punctuation">`</span>title<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>             <span class="token comment">-- 标题</span>
  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>                     <span class="token comment">-- 内容</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>article<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>author_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>category_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>views<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>comments<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>title<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>content<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
  <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> article<span class="token punctuation">;</span>

</code></pre></div><h3 id="需求"><a href="#需求" aria-hidden="true" class="header-anchor">#</a> 需求</h3> <p>查询category_id为1,且commonts大于1的情况下，views最多的article_id</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> author_id <span class="token keyword">FROM</span> article <span class="token keyword">WHERE</span> category_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> comments <span class="token operator">&gt;</span><span class="token number">1</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> views <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="分析"><a href="#分析" aria-hidden="true" class="header-anchor">#</a> 分析</h3> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> author_id <span class="token keyword">FROM</span> article <span class="token keyword">WHERE</span> category_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> comments <span class="token operator">&gt;</span><span class="token number">1</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> views <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>   <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> article <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">33.33</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>


</code></pre></div><ul><li>由于type为ALL,所以进行了全表扫描。</li> <li>extra字段包含了Using filesort，所以进行了文件内排序。</li> <li>以上两点证明了，sql性能并不好</li></ul> <h2 id="开始优化"><a href="#开始优化" aria-hidden="true" class="header-anchor">#</a> 开始优化</h2> <h4 id="_1-建索引"><a href="#_1-建索引" aria-hidden="true" class="header-anchor">#</a> 1.建索引</h4> <p>把where后面的字段全部建上索引</p> <p>两种建索引的方式</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>article<span class="token punctuation">`</span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> idx_article_ccv<span class="token punctuation">(</span><span class="token punctuation">`</span>category_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>comments<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>views<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> idx_article_ccv <span class="token keyword">on</span> article<span class="token punctuation">(</span>category_id<span class="token punctuation">,</span> comments<span class="token punctuation">,</span> views<span class="token punctuation">)</span>
</code></pre></div><h4 id="查看索引"><a href="#查看索引" aria-hidden="true" class="header-anchor">#</a> 查看索引</h4> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> article<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------+------------+-----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span>
<span class="token operator">|</span> <span class="token keyword">Table</span>   <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name        <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Sub_part <span class="token operator">|</span> Packed <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> Index_type <span class="token operator">|</span> <span class="token keyword">Comment</span> <span class="token operator">|</span> Index_comment <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+------------+-----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span>
<span class="token operator">|</span> article <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>         <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> id          <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">3</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>      <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span>
<span class="token operator">|</span> article <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_article_ccv <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> category_id <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">2</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>      <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span>
<span class="token operator">|</span> article <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_article_ccv <span class="token operator">|</span>            <span class="token number">2</span> <span class="token operator">|</span> comments    <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">3</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>      <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span>
<span class="token operator">|</span> article <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_article_ccv <span class="token operator">|</span>            <span class="token number">3</span> <span class="token operator">|</span> views       <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">3</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>      <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+------------+-----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><h3 id="再次分析"><a href="#再次分析" aria-hidden="true" class="header-anchor">#</a> 再次分析</h3> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span>  <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> author_id <span class="token keyword">FROM</span> article <span class="token keyword">WHERE</span> category_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> comments <span class="token operator">&gt;</span><span class="token number">1</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> views <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+---------+------------+-------+-----------------+-----------------+---------+------+------+----------+---------------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>   <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys   <span class="token operator">|</span> <span class="token keyword">key</span>             <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+---------+------------+-------+-----------------+-----------------+---------+------+------+----------+---------------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> article <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> idx_article_ccv <span class="token operator">|</span> idx_article_ccv <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition<span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+---------+------------+-------+-----------------+-----------------+---------+------+------+----------+---------------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

</code></pre></div><ul><li>查询用到了索引</li> <li>但是文件内排序依然存在。</li></ul> <h2 id="结论"><a href="#结论" aria-hidden="true" class="header-anchor">#</a> 结论</h2> <ul><li>type变成range,这是可以忍受的，但是extra里使用Using filesort仍是无法接受的</li> <li>但是我们已经建立了索引，为啥没用呢 ？</li> <li>这是因为按照BTree索引的工作原理，先排序category_id,如果遇到相同category_id，再排序comments,如果遇到相同的comments则再排序views.</li> <li>当comments字段在联合索引里处于中间位置时，因comments &gt; 1条件是一个范围值（所谓range）,MySQL无法利用索引再对后面的views进行检索，即range类型查询的字段后面的索引无效。</li></ul> <p>##进一步优化</p> <p>1.删除索引</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_article_ccv <span class="token keyword">ON</span> article<span class="token punctuation">;</span>

</code></pre></div><p>2.再建索引</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">index</span> idx_article_cv <span class="token keyword">on</span> article<span class="token punctuation">(</span>category_id <span class="token punctuation">,</span> views<span class="token punctuation">)</span>
</code></pre></div><p>3.再分析</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> author_id <span class="token keyword">FROM</span> article <span class="token keyword">WHERE</span> category_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> comments <span class="token operator">&gt;</span><span class="token number">1</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> views <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+---------+------------+------+----------------+----------------+---------+-------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>   <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys  <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+---------+------------+------+----------------+----------------+---------+-------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> article <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_article_cv <span class="token operator">|</span> idx_article_cv <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">33.33</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+---------+------------+------+----------------+----------------+---------+-------+------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><p>此时文件内排序已经没有了。</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/27.6d00f7aa.js" defer></script><script src="/assets/js/app.f518d815.js" defer></script>
  </body>
</html>
