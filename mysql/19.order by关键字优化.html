<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>19.order by关键字优化 | 陈新磊的读书笔记</title>
    <meta name="description" content="Just playing around">
    
    
    <link rel="preload" href="/assets/css/styles.f518d815.css" as="style"><link rel="preload" href="/assets/js/app.f518d815.js" as="script"><link rel="preload" href="/assets/js/18.cfdb5582.js" as="script"><link rel="prefetch" href="/assets/js/16.a05f5c53.js"><link rel="prefetch" href="/assets/css/1.styles.5a8ea794.css"><link rel="prefetch" href="/assets/js/1.5a8ea794.js"><link rel="prefetch" href="/assets/css/2.styles.cf289c67.css"><link rel="prefetch" href="/assets/js/2.cf289c67.js"><link rel="prefetch" href="/assets/js/3.ebd152b3.js"><link rel="prefetch" href="/assets/js/4.17531713.js"><link rel="prefetch" href="/assets/js/5.af9e6587.js"><link rel="prefetch" href="/assets/js/6.fc925cca.js"><link rel="prefetch" href="/assets/js/7.603902a0.js"><link rel="prefetch" href="/assets/js/8.d2d6cb3f.js"><link rel="prefetch" href="/assets/js/9.1b044dfa.js"><link rel="prefetch" href="/assets/js/10.931c5de7.js"><link rel="prefetch" href="/assets/js/11.c02b6a22.js"><link rel="prefetch" href="/assets/js/12.905af051.js"><link rel="prefetch" href="/assets/js/13.43b353fc.js"><link rel="prefetch" href="/assets/js/14.6b313113.js"><link rel="prefetch" href="/assets/js/15.f92f208f.js"><link rel="prefetch" href="/assets/js/17.f7e63732.js"><link rel="prefetch" href="/assets/js/19.f9c23d6f.js"><link rel="prefetch" href="/assets/js/20.ca5cacc5.js"><link rel="prefetch" href="/assets/js/21.b9a3f6bf.js"><link rel="prefetch" href="/assets/js/22.ad52503d.js"><link rel="prefetch" href="/assets/js/23.b50655b8.js"><link rel="prefetch" href="/assets/js/24.ae33eca4.js"><link rel="prefetch" href="/assets/js/25.35319afc.js"><link rel="prefetch" href="/assets/js/26.14cfb51c.js"><link rel="prefetch" href="/assets/js/27.6d00f7aa.js"><link rel="prefetch" href="/assets/js/28.9adb62e6.js"><link rel="prefetch" href="/assets/js/29.96b612e5.js"><link rel="prefetch" href="/assets/js/30.d16089d8.js"><link rel="prefetch" href="/assets/js/31.833984b0.js"><link rel="prefetch" href="/assets/js/32.0f873b57.js"><link rel="prefetch" href="/assets/js/33.e1a966ad.js"><link rel="prefetch" href="/assets/js/34.1e435d13.js"><link rel="prefetch" href="/assets/js/35.400e2100.js">
    <link rel="stylesheet" href="/assets/css/1.styles.5a8ea794.css"><link rel="stylesheet" href="/assets/css/2.styles.cf289c67.css"><link rel="stylesheet" href="/assets/css/styles.f518d815.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">陈新磊的读书笔记</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/python/fabric.html" class="nav-link">主页</a></div><div class="nav-item"><a href="/mongodb/" class="nav-link">MongoDB</a></div><div class="nav-item"><a href="/redis/" class="nav-link">Redis</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/python/fabric.html" class="nav-link">主页</a></div><div class="nav-item"><a href="/mongodb/" class="nav-link">MongoDB</a></div><div class="nav-item"><a href="/redis/" class="nav-link">Redis</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>Python</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/python/fabric.html" class="sidebar-link">自动化部署工具Fabric</a></li><li><a href="/python/subprocess.html" class="sidebar-link">Subprocess调用shell命令</a></li><li><a href="/python/pexpect.html" class="sidebar-link">自动化交互式的命令行pexpect</a></li><li><a href="/python/crashzip.html" class="sidebar-link">暴力破解zip压缩包的密码</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>JAVA</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/java/jvm.html" class="sidebar-link">JVM性能调优</a></li><li><a href="/java/thread.html" class="sidebar-link">多线程</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>MySQL</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/mysql/1.Install-MySQL5.7.22.html" class="sidebar-link">1. MySQL 5.7.22安装</a></li><li><a href="/mysql/2.MySQL-User-Manager.html" class="sidebar-link">2. MySQL 用户管理</a></li><li><a href="/mysql/3.MySQL备份与还原.html" class="sidebar-link">3.MySql备份与还原</a></li><li><a href="/mysql/4.七种连接方式.html" class="sidebar-link">4.七种连接方式</a></li><li><a href="/mysql/5.MySQL索引01.html" class="sidebar-link">5.MySQL索引（一）</a></li><li><a href="/mysql/6.MySQL索引02.html" class="sidebar-link">6.MySQL索引(二)</a></li><li><a href="/mysql/7.单表优化案例.html" class="sidebar-link">7.单表优化案例</a></li><li><a href="/mysql/8.两表和三表优化案例.html" class="sidebar-link">8. 两表和三表优化案例</a></li><li><a href="/mysql/9.索引优化01.html" class="sidebar-link">9.索引优化(一)</a></li><li><a href="/mysql/10.索引优化02.html" class="sidebar-link">10.索引优化(二)</a></li><li><a href="/mysql/11.索引优化03.html" class="sidebar-link">11. 索引优化(三)</a></li><li><a href="/mysql/12.索引优化04.html" class="sidebar-link">12. 索引优化(四)</a></li><li><a href="/mysql/13.索引优化05.html" class="sidebar-link">13.索引优化(五)</a></li><li><a href="/mysql/14.索引优化06.html" class="sidebar-link">14. 索引优化(六)</a></li><li><a href="/mysql/15.索引优化07.html" class="sidebar-link">15.索引优化(七)</a></li><li><a href="/mysql/16.索引优化08.html" class="sidebar-link">16.索引优化(八)</a></li><li><a href="/mysql/17.索引面试题.html" class="sidebar-link">17.索引面试题</a></li><li><a href="/mysql/18.小表驱动大表.html" class="sidebar-link">18.小表驱动大表</a></li><li><a href="/mysql/19.order by关键字优化.html" class="active sidebar-link">19.order by关键字优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mysql/19.order by关键字优化.html#准备数据" class="sidebar-link">准备数据</a></li><li class="sidebar-sub-header"><a href="/mysql/19.order by关键字优化.html#以下只关注有没有使用-filesort" class="sidebar-link">以下只关注有没有使用 filesort</a></li><li class="sidebar-sub-header"><a href="/mysql/19.order by关键字优化.html#mysql支持二种方式的排序，filesort和index-index效率高。它指mysql扫描索引本身完成排序。filesort方式效率较低" class="sidebar-link">MySQL支持二种方式的排序，FileSort和Index, Index效率高。它指MySQL扫描索引本身完成排序。FileSort方式效率较低</a></li><li class="sidebar-sub-header"><a href="/mysql/19.order by关键字优化.html#order-by满足两情况，会使用index方式排序：" class="sidebar-link">ORDER BY满足两情况，会使用INDEX方式排序：</a></li><li class="sidebar-sub-header"><a href="/mysql/19.order by关键字优化.html#filesort有两种算法：双路排序算法和单路排序算法" class="sidebar-link">filesort有两种算法：双路排序算法和单路排序算法</a></li><li class="sidebar-sub-header"><a href="/mysql/19.order by关键字优化.html#优化策略" class="sidebar-link">优化策略</a></li><li class="sidebar-sub-header"><a href="/mysql/19.order by关键字优化.html#为排序使用索引" class="sidebar-link">为排序使用索引</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mysql/19.order by关键字优化.html#mysql两种排序方式：文件排序或扫描有序索引排序" class="sidebar-link">MySQL两种排序方式：文件排序或扫描有序索引排序</a></li><li class="sidebar-sub-header"><a href="/mysql/19.order by关键字优化.html#mysql能为排序玮查询使用相同的索引" class="sidebar-link">MySQL能为排序玮查询使用相同的索引</a></li><li class="sidebar-sub-header"><a href="/mysql/19.order by关键字优化.html#order-by能使用索引最左前缀" class="sidebar-link">order by能使用索引最左前缀</a></li><li class="sidebar-sub-header"><a href="/mysql/19.order by关键字优化.html#如果-where使用索引的最左前缀为常量，则order-by能使用索引排序-不产生filessort" class="sidebar-link">如果 WHERE使用索引的最左前缀为常量，则order by能使用索引排序,不产生filessort</a></li><li class="sidebar-sub-header"><a href="/mysql/19.order by关键字优化.html#不能使用索引进行排序" class="sidebar-link">不能使用索引进行排序</a></li></ul></li><li class="sidebar-sub-header"><a href="/mysql/19.order by关键字优化.html#group-by-关键字优化" class="sidebar-link">GROUP BY 关键字优化</a></li></ul></li><li><a href="/mysql/20.慢查询日志分析.html" class="sidebar-link">20.慢查询日志分析</a></li><li><a href="/mysql/21.批量数据脚本.html" class="sidebar-link">21.批量数据脚本</a></li><li><a href="/mysql/22.Show Profile.html" class="sidebar-link">22.Show Profile</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="_19-order-by关键字优化"><a href="#_19-order-by关键字优化" aria-hidden="true" class="header-anchor">#</a> 19.order by关键字优化</h1> <p>order by 子句，尽量使用index方式排序，避免使用filesort方式排序</p> <h2 id="准备数据"><a href="#准备数据" aria-hidden="true" class="header-anchor">#</a> 准备数据</h2> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tblA<span class="token punctuation">(</span>
  <span class="token comment">#`id` INT PRIMARY KEY NOT NULL AUTO_INCREMENT,</span>
  age <span class="token keyword">INT</span><span class="token punctuation">,</span>
  birth <span class="token keyword">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_A_ageBirth <span class="token keyword">ON</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tblA<span class="token punctuation">;</span>

</code></pre></div><h2 id="以下只关注有没有使用-filesort"><a href="#以下只关注有没有使用-filesort" aria-hidden="true" class="header-anchor">#</a> 以下只关注有没有使用 filesort</h2> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">order</span> <span class="token keyword">by</span>字段，带头大哥在

mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tblA <span class="token keyword">WHERE</span> age <span class="token operator">&gt;</span> <span class="token number">20</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+--------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys  <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+--------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> tblA  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> idx_A_ageBirth <span class="token operator">|</span> idx_A_ageBirth <span class="token operator">|</span> <span class="token number">9</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+--------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">order</span> <span class="token keyword">by</span>字段，带头大哥在

mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tblA <span class="token keyword">WHERE</span> age <span class="token operator">&gt;</span> <span class="token number">20</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">,</span> birth<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+--------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys  <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+--------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> tblA  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> idx_A_ageBirth <span class="token operator">|</span> idx_A_ageBirth <span class="token operator">|</span> <span class="token number">9</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+--------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><p>order by字段，带头大哥不在</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tblA <span class="token keyword">WHERE</span> age <span class="token operator">&gt;</span> <span class="token number">20</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> birth<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys  <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> tblA  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> idx_A_ageBirth <span class="token operator">|</span> idx_A_ageBirth <span class="token operator">|</span> <span class="token number">9</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><p>order by字段顺序与索引字段不一致</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tblA <span class="token keyword">WHERE</span> age <span class="token operator">&gt;</span> <span class="token number">20</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> birth<span class="token punctuation">,</span> age<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys  <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> tblA  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> idx_A_ageBirth <span class="token operator">|</span> idx_A_ageBirth <span class="token operator">|</span> <span class="token number">9</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

</code></pre></div><p>带头大哥不在</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tblA <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> birth<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-----------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-----------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> tblA  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> idx_A_ageBirth <span class="token operator">|</span> <span class="token number">9</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-----------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><p>带头大哥不在</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tblA <span class="token keyword">where</span> birth <span class="token operator">&gt;</span> <span class="token string">'2016-01-28 00:00:00'</span>  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> birth<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+------------------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+------------------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> tblA  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> idx_A_ageBirth <span class="token operator">|</span> <span class="token number">9</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">33.33</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+------------------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

</code></pre></div><p>带头大哥 在</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tblA <span class="token keyword">where</span> birth <span class="token operator">&gt;</span> <span class="token string">'2016-01-28 00:00:00'</span>  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+--------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+--------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> tblA  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> idx_A_ageBirth <span class="token operator">|</span> <span class="token number">9</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">33.33</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+--------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


</code></pre></div><p>两个字段排序方向不一致</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tblA  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">ASC</span><span class="token punctuation">,</span> birth <span class="token keyword">DESC</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-----------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-----------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> tblA  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> idx_A_ageBirth <span class="token operator">|</span> <span class="token number">9</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-----------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

</code></pre></div><h2 id="mysql支持二种方式的排序，filesort和index-index效率高。它指mysql扫描索引本身完成排序。filesort方式效率较低"><a href="#mysql支持二种方式的排序，filesort和index-index效率高。它指mysql扫描索引本身完成排序。filesort方式效率较低" aria-hidden="true" class="header-anchor">#</a> MySQL支持二种方式的排序，FileSort和Index, Index效率高。它指MySQL扫描索引本身完成排序。FileSort方式效率较低</h2> <h2 id="order-by满足两情况，会使用index方式排序："><a href="#order-by满足两情况，会使用index方式排序：" aria-hidden="true" class="header-anchor">#</a> ORDER BY满足两情况，会使用INDEX方式排序：</h2> <ul><li><ol><li>ORDER BY 语句使用索引最左前列</li></ol></li> <li><ol start="2"><li>使用Where子句与ORDER BY 子句条件列组合满足索引最左前列</li></ol></li></ul> <h2 id="filesort有两种算法：双路排序算法和单路排序算法"><a href="#filesort有两种算法：双路排序算法和单路排序算法" aria-hidden="true" class="header-anchor">#</a> filesort有两种算法：双路排序算法和单路排序算法</h2> <ul><li>双路排序：MySQL4.1之前使用双路排序，字面意思是两次扫描磁盘，最终得到数据。</li> <li>单路排序：从磁盘读取查询需要的所有列，按照order by列在buffer对它们进行排序，然后扫描排序后的列表进行输出，它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO,但是它会使用更多的空间，因为它把每一行都保存在内存中了。</li></ul> <p>在sort_buffer中，方法B比方法A要多占用很多空间，因为方法B是把所有字段都取出，所以有可能取出的数据的总大小超出了sort_buffer的容量，导致每次只能取sort_buffer容量大小的数据进行排序（创建tmp文件，多路合并），排完再取sort_buffer容量大小，再排......从而多次IO.</p> <p>本来想省一次IO操作，反而导致了大量的IO 操作，反而得不偿失。</p> <h2 id="优化策略"><a href="#优化策略" aria-hidden="true" class="header-anchor">#</a> 优化策略</h2> <ul><li>增大sort_buffer_size参数的设置</li> <li>增大max_length_for_sort_dataf参数设置</li></ul> <h1 id="提高order-by的速度"><a href="#提高order-by的速度" aria-hidden="true" class="header-anchor">#</a> 提高Order by的速度</h1> <ul><li>1.Order by 时select  * 是一个大忌，只查询需要的字段，这点非常重要。在这里的影响是：
<ul><li>1.1 当查询的字段大小总和小于max_length_for_sort_data而且排序字段不是TEXT|BLOB类型时，会用改进后的算法--单路排序，否则用老算法--多路排序。</li> <li>1.2 两种算法的数据都有可能超出sort_buffer的容量，超出之后，会创建 tmp文件进行合并排序，导致多次IO。此时单路排序算法的性能还不如双路，所以要提高sort_buffer_size.</li></ul></li> <li><ol start="2"><li>尝试提高sort_buffer_size  , 不管用哪种算法，会增加用改进算法的概率。但是如果设的太高，数据总容量超出sort_buffer_size的概率就增大，明显症状是高的磁盘IO活动和低的处理器使用率。</li></ol></li></ul> <h2 id="为排序使用索引"><a href="#为排序使用索引" aria-hidden="true" class="header-anchor">#</a> 为排序使用索引</h2> <h3 id="mysql两种排序方式：文件排序或扫描有序索引排序"><a href="#mysql两种排序方式：文件排序或扫描有序索引排序" aria-hidden="true" class="header-anchor">#</a> MySQL两种排序方式：文件排序或扫描有序索引排序</h3> <h3 id="mysql能为排序玮查询使用相同的索引"><a href="#mysql能为排序玮查询使用相同的索引" aria-hidden="true" class="header-anchor">#</a> MySQL能为排序玮查询使用相同的索引</h3> <p>KEY a_b_c(a,b,c)</p> <h3 id="order-by能使用索引最左前缀"><a href="#order-by能使用索引最左前缀" aria-hidden="true" class="header-anchor">#</a> order by能使用索引最左前缀</h3> <ul><li>ORDER BY a</li> <li>ORDER BY a,b</li> <li>ORDER BY a,b,c</li> <li>ORDER BY a DESC, b DESC, c DESC</li></ul> <h3 id="如果-where使用索引的最左前缀为常量，则order-by能使用索引排序-不产生filessort"><a href="#如果-where使用索引的最左前缀为常量，则order-by能使用索引排序-不产生filessort" aria-hidden="true" class="header-anchor">#</a> 如果 WHERE使用索引的最左前缀为常量，则order by能使用索引排序,不产生filessort</h3> <ul><li>WHERE a=const ORDER BY b, c</li> <li>WHERE a=const AND b=const ORDER BY c</li> <li>WHER  a=const ORDER BY b,c</li> <li>WHERE a=const AND b&gt;const ORDER BY b,c</li></ul> <h3 id="不能使用索引进行排序"><a href="#不能使用索引进行排序" aria-hidden="true" class="header-anchor">#</a> 不能使用索引进行排序</h3> <ul><li>ORDER BY a ASC, b DESC, c DESC  排序不一致</li> <li>WHERE g=const ORDER BY b,c      丢失a索引</li> <li>WHERE a=const ORDER BY c        丢失b索引</li> <li>WHERE a=const ORDER BY a,d      d不是索引的一部分</li> <li>WHERE a in(...) ORDER BY b,c    对于排序来说，多个相等条件也是范围查询</li></ul> <h2 id="group-by-关键字优化"><a href="#group-by-关键字优化" aria-hidden="true" class="header-anchor">#</a> GROUP BY 关键字优化</h2> <ul><li>group by 实质是先排序后再分组，尊照索引建的最佳左前缀</li> <li>无法使用索引列， 增大max_length_for_sort_data参数的设置+增大sort_buffer_size参数的设置</li> <li>where 高于having，能写在where限定的条件就不要去having限定了。</li></ul></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/18.cfdb5582.js" defer></script><script src="/assets/js/app.f518d815.js" defer></script>
  </body>
</html>
